<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è´¢åŠ¡ç®¡å®¶ (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* === ä¿æŒåŸç‰ˆ UI å˜é‡ === */
        :root {
            --primary: #4e54c8;
            --primary-light: #8f94fb;
            --success: #00b894;
            --danger: #ff7675;
            --warning: #fdcb6e;
            --bg: #f7f8fa;
            --card-bg: #ffffff;
            --nav-height: 60px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: #333;
            margin: 0; padding: 0;
            height: 100vh; height: 100dvh;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        #app {
            flex: 1; position: relative; overflow: hidden;
            width: 100%; max-width: 600px; margin: 0 auto;
            background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }

        /* === ğŸ¬ é¡µé¢åˆ‡æ¢åŠ¨ç”» === */
        @keyframes springUp {
            0% { transform: scale(0.96) translateY(10px); opacity: 0; }
            60% { transform: scale(1.01) translateY(-2px); opacity: 1; }
            100% { transform: scale(1) translateY(0); }
        }

        .view-container {
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: calc(var(--nav-height) + var(--safe-area-bottom) + 20px);
            display: none; opacity: 0;
            -webkit-overflow-scrolling: touch;
        }
        .view-container.active { 
            display: block; opacity: 1; 
            animation: springUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 600px;
            height: calc(var(--nav-height) + var(--safe-area-bottom));
            padding-bottom: var(--safe-area-bottom);
            background: rgba(255,255,255,0.98); backdrop-filter: blur(10px);
            border-top: 1px solid #eee;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 900;
        }
        .nav-item {
            flex: 1; text-align: center; color: #999; font-size: 10px;
            cursor: pointer; padding-top: 5px; height: 100%;
            display: flex; flex-direction: column; justify-content: start;
        }
        .nav-item .icon { font-size: 24px; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.active .icon { transform: scale(1.1); transition: transform 0.2s; }

        header { padding: 15px 0 5px; text-align: center; flex-shrink: 0;}
        h1 { margin: 0; font-size: 20px; color: #2d3436; font-weight: 800; }

        .card {
            background: var(--card-bg); border-radius: 16px;
            padding: 16px; margin-bottom: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02);
            position: relative; 
        }
        .card-title { font-size: 16px; font-weight: bold; margin: 0 0 12px 0; color: #333; display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap;}
        
        .chart-type-switch { display: flex; gap: 5px; }
        .type-btn {
            background: #f0f0f0; border: none; padding: 4px 8px; border-radius: 6px;
            font-size: 14px; cursor: pointer; color: #666; transition: all 0.2s;
        }
        .type-btn.active { background: var(--primary); color: white; }

        /* ç­›é€‰æ  */
        .chart-filter-bar {
            background: #f8f9fa; padding: 10px; border-radius: 12px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px; border: 1px solid #eee;
            overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch;
        }
        .chart-filter-bar::-webkit-scrollbar { display: none; }
        .date-picker-range { 
            flex: 1; min-width: 110px; padding: 8px; border-radius: 8px; 
            border: 1px solid #ddd; background: #fff; font-size: 13px; 
            outline: none; -webkit-appearance: none; text-align: center;
        }
        .range-sep { color: #999; font-size: 12px; font-weight: bold; }

        /* é¦–é¡µç»„ä»¶ */
        .budget-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .budget-top { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; opacity: 0.9; }
        .budget-main { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .budget-bar { background: rgba(255,255,255,0.3); height: 6px; border-radius: 3px; overflow: hidden; }
        .budget-fill { background: #fff; height: 100%; width: 0%; border-radius: 3px; transition: width 0.5s; }
        .budget-set-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-box { background: #f8f9fa; padding: 12px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .stat-val { font-size: 16px; font-weight: bold; }
        .c-in { color: var(--success); } .c-out { color: var(--danger); }
        .c-save { color: var(--primary); } .c-debt { color: var(--warning); }

        /* === ğŸ“ è¡¨å•æ ·å¼ (å·¦å¯¹é½) === */
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-col { flex: 1; }
        label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 500; text-align: left; }
        
        input, select {
            width: 100%; padding: 10px 10px;
            border: 1px solid #eee; background: #f9f9f9;
            border-radius: 10px; font-size: 15px; outline: none; -webkit-appearance: none;
            text-align: left;
        }
        input:focus, select:focus { background: #fff; border-color: var(--primary); }
        
        .btn-submit {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            background: var(--danger); color: white; font-size: 16px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 118, 117, 0.4); cursor: pointer; transition: transform 0.1s;
            text-align: center;
        }
        .btn-submit:active { transform: scale(0.96); }

        .chart-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch;}
        .chart-pill {
            padding: 6px 16px; background: #eee; border-radius: 20px; font-size: 13px; color: #666; white-space: nowrap; cursor: pointer;
        }
        .chart-pill.active { background: var(--primary); color: white; }
        .chart-container { position: relative; height: 300px; width: 100%; overflow: hidden; }
        .chart-view { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--card-bg); opacity: 0; visibility: hidden; transition: opacity 0.3s; z-index: 0;
        }
        .chart-view.active { opacity: 1; visibility: visible; z-index: 1; }

        .trans-list { list-style: none; padding: 0; margin: 0; }
        .trans-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
        .t-left { display: flex; align-items: center; gap: 12px; }
        .t-icon { width: 40px; height: 40px; background: #f4f6f8; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .t-info h4 { margin: 0; font-size: 15px; color: #333; }
        .t-info span { font-size: 12px; color: #999; }
        .t-amount { font-weight: bold; font-size: 16px; }
        .del-btn { background: none; border: none; color: #ddd; font-size: 18px; padding: 0 0 0 10px;}

        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .setting-label { font-size: 15px; font-weight: 500; }
        .setting-action button { padding: 8px 15px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; }
        .btn-backup { background: #e3f2fd; color: #2196f3; }
        .btn-recover { background: #f3e5f5; color: #9c27b0; }
        .btn-excel { background: #e8f5e9; color: #4caf50; }
        
        /* === ğŸ”§ åˆ†ç±»ç®¡ç† === */
        .cat-list { list-style: none; padding: 0; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; max-height: 200px; overflow-y: auto;}
        .cat-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; }
        .cat-name-span { font-size: 15px; font-weight: 500; display: flex; align-items: center; gap: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .cat-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .cat-btn { border: none; border-radius: 6px; padding: 5px 10px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .btn-edit { background: #e3f2fd; color: #4e54c8; }
        .btn-del { background: #ffebee; color: #ff7675; }

        /* === ğŸ“­ ç©ºçŠ¶æ€ === */
        .chart-empty-state {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; 
            flex-direction: column; align-items: center; justify-content: center;
            background: #ffffff; 
            z-index: 100; color: #ccc; 
        }
        .list-empty-state { padding: 40px 0; text-align: center; color: #bbb; font-size: 14px; }
        .empty-icon { font-size: 48px; margin-bottom: 10px; opacity: 0.6; }
        .empty-text { font-size: 14px; }

        /* === ğŸ¬ åŠ¨ç”»å±‚ === */
        #anim-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 11000; overflow: hidden; display: none;}
        .run-anim { position: absolute; top: 50%; right: -150px; transform: translateY(-50%); animation: runAcross 2.5s linear forwards; display: flex; align-items: center; font-size: 90px; }
        .bounce-body { animation: bounce 0.3s infinite alternate; position: relative; }
        .money-tag { position: absolute; font-size: 40px; top: 0; left: 25px; z-index: 2; transform: rotate(-10deg); }
        @keyframes runAcross { 0% { right: -150px; transform: translateY(-50%) translateX(0); } 100% { right: 100%; transform: translateY(-50%) translateX(-100px); } }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }
        .pop-anim { position: absolute; left: 50%; top: 40%; transform: translate(-50%, -50%) scale(0); font-size: 100px; animation: popIn 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; text-align: center; white-space: nowrap; z-index: 11001; }
        .pop-text { display: block; font-size: 24px; color: #fdcb6e; margin-top: 15px; font-weight: bold; background: #fff; padding: 10px 25px; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        @keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0;} 50% { opacity: 1;} 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

        /* === ğŸ§­ èšå…‰ç¯æŒ‡å¼• === */
        #spotlight-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9990; display: none; }
        .spotlight-box { position: absolute; border-radius: 12px; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); border: 2px solid rgba(255,255,255,0.8); pointer-events: none; }
        .guide-tooltip { position: fixed; left: 50%; transform: translateX(-50%); width: 85%; max-width: 300px; background: #fff; padding: 25px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.6); z-index: 10002; opacity: 0; transition: opacity 0.3s, bottom 0.4s, top 0.4s; pointer-events: auto; }
        .guide-tooltip.show { opacity: 1; }
        .guide-tooltip.bottom-mode { top: auto; bottom: 120px; }
        .guide-tooltip.top-mode { bottom: auto; top: 80px; }
        .guide-tooltip.center-mode { top: 50%; bottom: auto; transform: translate(-50%, -50%); }
        .guide-lion { font-size: 40px; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background:#fff; border-radius:50%; width:50px; height:50px; line-height:50px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .guide-title { font-size: 16px; font-weight: bold; margin-top: 15px; margin-bottom: 8px; color: var(--primary); }
        .guide-text { font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.5; }
        .guide-btn-row { display: flex; gap: 10px; justify-content: center; }
        .guide-btn { border: none; padding: 8px 20px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; }
        .btn-skip { background: #f0f0f0; color: #999; }
        .btn-next { background: var(--primary); color: white; }
        .guide-highlight { position: relative; z-index: 10000 !important; box-shadow: 0 0 0 5px rgba(255, 255, 255, 0.6), 0 0 0 9999px rgba(0,0,0,0.75) !important; transition: all 0.3s; background-color: var(--card-bg); }

        #success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 12000; display: none; align-items: center; justify-content: center; }
        .success-box { background: transparent; padding: 40px; text-align: center; color: #fff; animation: popInSuccess 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .success-icon { font-size: 100px; margin-bottom: 20px; display: inline-block; animation: bounceIcon 1s infinite alternate; }
        .success-text { font-size: 30px; font-weight: 900; color: #fdcb6e; text-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes popInSuccess { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes bounceIcon { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* === ğŸ¯ æç¤ºæ¡†ä¼˜åŒ–ï¼šå±…ä¸­ + å»¶æ—¶ === */
        #toast { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); /* ç»å¯¹å±…ä¸­ */
            background: rgba(0,0,0,0.85); color: white; padding: 15px 30px; 
            border-radius: 12px; font-size: 15px; font-weight: bold;
            z-index: 13000; opacity: 0; transition: opacity 0.3s; pointer-events: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }
        #toast.show { opacity: 1; }
        
        #file-input { display: none; }
        .list-filter-bar { display: flex; gap: 8px; margin-bottom: 10px; }
        .list-filter-bar input { flex: 2; padding: 8px; font-size: 13px; border-radius: 8px; text-align: left; }
        .list-filter-bar select { flex: 1; padding: 8px; font-size: 13px; border-radius: 8px; text-align: left; }
    </style>
</head>
<body>

<div id="app">
    <header><h1>ğŸ¦ è´¢åŠ¡ç®¡å®¶</h1></header>

    <div id="view-home" class="view-container active">
        <div class="card budget-card" id="target-budget">
            <div class="budget-top"><span>ğŸ“… æœ¬æœˆé¢„ç®—</span><button class="budget-set-btn" onclick="setBudget()">è®¾ç½®</button></div>
            <div class="budget-main" id="budget-display">Â¥0.00</div>
            <div class="budget-bar"><div class="budget-fill" id="budget-fill"></div></div>
            <div style="margin-top:8px; font-size:12px; display:flex; justify-content:space-between;"><span id="budget-text">å·²ç”¨ 0%</span><span>å‰©ä½™: <strong id="budget-remaining">Â¥0.00</strong></span></div>
        </div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">æœ¬æœˆæ”¶å…¥</div><div class="stat-val c-in" id="month-income">Â¥0.00</div></div>
            <div class="stat-box"><div class="stat-label">æœ¬æœˆæ”¯å‡º</div><div class="stat-val c-out" id="month-expense">Â¥0.00</div></div>
            <div class="stat-box"><div class="stat-label">ç´¯è®¡å‚¨è“„</div><div class="stat-val c-save" id="total-savings">Â¥0.00</div></div>
            <div class="stat-box"><div class="stat-label">å¾…æ”¶æ¬ æ¬¾</div><div class="stat-val c-debt" id="total-debt">Â¥0.00</div></div>
        </div>
        <div class="card" style="margin-top: 16px;" id="target-form">
            <div class="card-title">âœï¸ å¿«é€Ÿè®°è´¦</div>
            <form id="transaction-form">
                <div class="form-row"><div class="form-col"><label>æ—¥æœŸ</label><input type="date" id="date" required /></div><div class="form-col"><label>é‡‘é¢</label><input type="number" id="amount" placeholder="0.00" step="0.01" required inputmode="decimal"/></div></div>
                <div class="form-row">
                    <div class="form-col"><label>ç±»å‹</label><select id="type" onchange="updateCategoryOptions()"><option value="expense">æ”¯å‡º (-)</option><option value="income">æ”¶å…¥ (+)</option><option value="savings_in">å­˜å…¥å‚¨è“„</option><option value="savings_out">å–å‡ºå‚¨è“„</option><option value="debt_out">å€Ÿå‡ºå€ºæƒ</option><option value="debt_in">æ”¶å›å€ºæƒ</option></select></div>
                    <div class="form-col"><label>åˆ†ç±»</label><select id="category"></select></div>
                </div>
                <div class="form-control" style="margin-bottom: 15px;"><label>å¤‡æ³¨ (é€‰å¡«)</label><input type="text" id="text" placeholder="ä¾‹å¦‚ï¼šæ—©é¤ã€æ‰“è½¦..." /></div>
                <button type="submit" id="btn-submit" class="btn-submit">è®°ä¸€ç¬”</button>
            </form>
        </div>
        <div class="card">
            <div class="card-title">ğŸ•’ æœ€è¿‘è®°å½•</div>
            <ul id="recent-list" class="trans-list"></ul>
        </div>
    </div>

    <div id="view-charts" class="view-container">
        <div class="card">
            <div class="card-title">
                <span>ğŸ“Š æ•°æ®åˆ†æ</span>
                <div class="chart-type-switch">
                    <button class="type-btn active" id="btn-doughnut" onclick="setChartType('doughnut')">ğŸ©</button>
                    <button class="type-btn" id="btn-bar" onclick="setChartType('bar')">ğŸ“Š</button>
                </div>
            </div>
            <div class="chart-filter-bar">
                <span style="font-size:12px;color:#666;">ğŸ“…</span>
                <input type="date" id="start-date" class="date-picker-range" onchange="renderChartsPage()">
                <span class="range-sep">è‡³</span>
                <input type="date" id="end-date" class="date-picker-range" onchange="renderChartsPage()">
            </div>
            <div id="target-chart">
                <div class="chart-tabs">
                    <div class="chart-pill active" onclick="switchChart('expense')">æ”¯å‡º</div>
                    <div class="chart-pill" onclick="switchChart('income')">æ”¶å…¥</div>
                    <div class="chart-pill" onclick="switchChart('savings')">å‚¨è“„</div>
                    <div class="chart-pill" onclick="switchChart('debt')">å€ºæƒ</div>
                </div>
                <div class="chart-container">
                    <div id="chart-empty-state" class="chart-empty-state">
                        <div class="empty-icon">ğŸ“‰</div><div class="empty-text">æš‚æ— æ•°æ®ï¼Œç‹®å­åœ¨æ‰“ç›¹</div>
                    </div>
                    <div id="chart-view-expense" class="chart-view active"><canvas id="expenseChart"></canvas></div>
                    <div id="chart-view-income" class="chart-view"><canvas id="incomeChart"></canvas></div>
                    <div id="chart-view-savings" class="chart-view"><canvas id="savingsChart"></canvas></div>
                    <div id="chart-view-debt" class="chart-view"><canvas id="debtChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ“œ ç­›é€‰æ˜ç»†</div>
            <div class="form-row">
                <input type="text" id="search-input" placeholder="ğŸ” æœå¤‡æ³¨/åˆ†ç±»..." oninput="renderFullList()">
                <select id="filter-select" style="width: 100px;" onchange="renderFullList()"><option value="all">å…¨éƒ¨</option><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option><option value="debt">å€ºæƒ</option></select>
            </div>
            <ul id="full-list" class="trans-list"></ul>
        </div>
    </div>

    <div id="view-settings" class="view-container">
        <div class="card" id="target-backup">
            <div class="card-title">âš™ï¸ æ•°æ®ç®¡ç†</div>
            <div class="setting-item"><div class="setting-label">å¯¼å‡º Excel è¡¨æ ¼</div><div class="setting-action"><button class="btn-excel" onclick="exportToExcel()">å¯¼å‡º csv</button></div></div>
            <div class="setting-item"><div class="setting-label">å¤‡ä»½æ•°æ®æ–‡ä»¶</div><div class="setting-action"><button class="btn-backup" onclick="exportData(true)">ä¸‹è½½å¤‡ä»½</button></div></div>
            <div class="setting-item"><div class="setting-label">æ¢å¤æ•°æ®</div><div class="setting-action"><button class="btn-recover" onclick="document.getElementById('file-input').click()">å¯¼å…¥æ–‡ä»¶</button><input type="file" id="file-input" accept=".json" onchange="importData(this)"></div></div>
            <div class="setting-item"><div class="setting-label">æ–°æ‰‹å¼•å¯¼</div><div class="setting-action"><button class="btn-backup" onclick="forceGuide()">é‡çœ‹æŒ‡å¼•</button></div></div>
        </div>
        <div class="card">
            <div class="card-title">ğŸ·ï¸ åˆ†ç±»ç®¡ç†</div>
            <div class="form-row">
                <select id="manage-type-select" onchange="renderManageList()"><option value="expense">æ”¯å‡º</option><option value="income">æ”¶å…¥</option><option value="savings_in">å­˜å…¥</option><option value="debt_out">å€Ÿå‡º</option></select>
            </div>
            <ul id="manage-list" class="cat-list"></ul>
            <div class="form-row" style="margin-top:10px; align-items: center;">
                <input type="text" id="new-cat-icon" placeholder="Emoji" style="width:60px; text-align:center;">
                <input type="text" id="new-cat-name" placeholder="æ–°åˆ†ç±»å">
                <button onclick="addNewCategory()" style="width:60px; margin:0; padding:10px; background:var(--success); color:white; border:none; border-radius:8px;">+</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav" id="target-nav">
        <div class="nav-item active" onclick="switchView('home')"><span class="icon">ğŸ </span>é¦–é¡µ</div>
        <div class="nav-item" onclick="switchView('charts')"><span class="icon">ğŸ“Š</span>å›¾è¡¨</div>
        <div class="nav-item" onclick="switchView('settings')"><span class="icon">âš™ï¸</span>è®¾ç½®</div>
    </div>
</div>

<div id="anim-layer"></div>
<div id="toast"></div>

<div id="spotlight-overlay">
    <div class="spotlight-box" id="spotlight-box"></div>
    <div class="guide-tooltip center-mode" id="guide-tooltip">
        <div class="guide-lion">ğŸ¦</div>
        <div class="guide-title" id="guide-title">Title</div>
        <div class="guide-text" id="guide-text">Text</div>
        <div class="guide-btn-row">
            <button class="guide-btn btn-skip" onclick="endGuide()">è·³è¿‡</button>
            <button class="guide-btn btn-next" onclick="nextGuide()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>
</div>

<div id="success-overlay">
    <div class="success-box">
        <div class="success-icon">ğŸ‰</div>
        <div class="success-text">ç¥ä½ è®°è´¦æ„‰å¿«ï¼</div>
    </div>
</div>

<script>
    // === å…¨å±€çŠ¶æ€ ===
    const viewList = ['home', 'charts', 'settings'];
    let currentViewIndex = 0;
    
    // === è§†å›¾åˆ‡æ¢ (æ”¯æŒæ»‘åŠ¨ + åˆå§‹åŒ–) ===
    function switchView(viewName) {
        document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const index = viewList.indexOf(viewName);
        document.querySelectorAll('.nav-item')[index].classList.add('active');
        currentViewIndex = index;

        // ç‰¹æ®Šåˆå§‹åŒ–
        if(viewName === 'charts') renderChartsPage(); 
        if(viewName === 'settings') renderManageList(); // ä¿®å¤ï¼šè¿›å…¥è®¾ç½®è‡ªåŠ¨æ¸²æŸ“åˆ—è¡¨
    }

    // === æ»‘åŠ¨ç›‘å¬ ===
    let touchStartX = 0;
    let touchStartY = 0;
    const minSwipeDist = 50;

    document.getElementById('app').addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, {passive: true});

    document.getElementById('app').addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].screenX;
        const touchEndY = e.changedTouches[0].screenY;
        const diffX = touchEndX - touchStartX;
        const diffY = touchEndY - touchStartY;

        // ç¡®ä¿æ˜¯æ°´å¹³æ»‘åŠ¨ (é˜²è¯¯è§¦å‚ç›´æ»šåŠ¨)
        if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > minSwipeDist) {
            if(diffX < 0) { // å·¦æ»‘ -> ä¸‹ä¸€é¡µ
                if(currentViewIndex < 2) switchView(viewList[currentViewIndex + 1]);
            } else { // å³æ»‘ -> ä¸Šä¸€é¡µ
                if(currentViewIndex > 0) switchView(viewList[currentViewIndex - 1]);
            }
        }
    });

    const defaultCategories = {
        expense: [{name:'é¤é¥®',icon:'ğŸ”'},{name:'è´­ç‰©',icon:'ğŸ›’'},{name:'äº¤é€š',icon:'ğŸš—'},{name:'æˆ¿ç§Ÿ',icon:'ğŸ '},{name:'å¨±ä¹',icon:'ğŸ®'}],
        income: [{name:'å·¥èµ„',icon:'ğŸ’°'},{name:'å…¼èŒ',icon:'âš¡'},{name:'ç†è´¢',icon:'ğŸ“ˆ'}],
        savings_in: [{name:'å­˜é’±',icon:'ğŸ¦'},{name:'åŸºé‡‘',icon:'ğŸ“Š'}],
        savings_out: [{name:'å–æ¬¾',icon:'ğŸ§'}],
        debt_out: [{name:'å€Ÿå‡º',icon:'ğŸ¤'},{name:'å«ä»˜',icon:'ğŸ“'}],
        debt_in: [{name:'è¿˜æ¬¾',icon:'ğŸ“¥'}]
    };

    let categoryData = JSON.parse(localStorage.getItem('categoryData')) || defaultCategories;
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let currentBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;
    
    let currentChartType = 'doughnut';
    let currentTab = 'expense';
    let chartDataStatus = { expense: false, income: false, savings: false, debt: false };

    function setChartType(type) {
        currentChartType = type;
        document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${type}`).classList.add('active');
        renderChartsPage();
    }

    // === æŒ‡å¼•é€»è¾‘ ===
    let guideStep = 0;
    const guideData = [
        { id: 'start', title: "æ¬¢è¿æ–°æœ‹å‹ï¼", text: "æˆ‘æ˜¯ä½ çš„è´¢åŠ¡å°ç‹®å­ã€‚\nèŠ± 1 åˆ†é’Ÿå¸¦ä½ ç†Ÿæ‚‰ä¸€ä¸‹æ–°å®¶å§ï¼", target: null },
        { id: 'budget', title: "ğŸ’° è®¾ç½®é¢„ç®—", text: "ç‚¹å‡»è¿™é‡Œè®¾ç½®æœ¬æœˆé¢„ç®—ã€‚\nå¿«èŠ±è¶…çš„æ—¶å€™æˆ‘ä¼šæé†’ä½ å“¦ï¼", target: 'target-budget' },
        { id: 'form', title: "âœï¸ æé€Ÿè®°è´¦", text: "æ—¥æœŸã€é‡‘é¢ã€åˆ†ç±»ï¼Œä¸€å±æå®šï¼\né‡‘é¢ä¸èƒ½ä¸º0ï¼Œä½ å¯ä»¥ã€ç›´æ¥æ“ä½œã€‘ï¼Œè®°å®Œä¸€ç¬”æˆ‘ä¼šè‡ªåŠ¨å¸¦ä½ ç»§ç»­ï¼", target: 'target-form' },
        { id: 'chart', title: "ğŸ“Š å›¾è¡¨åˆ†æ", text: "è‡ªåŠ¨ç”Ÿæˆæ”¶æ”¯é¥¼å›¾ï¼Œ\næ”¯æŒåœ¨ ğŸ©é¥¼å›¾ å’Œ ğŸ“Šæ¡å½¢å›¾ ä¹‹é—´åˆ‡æ¢ï¼", target: 'target-chart' },
        { id: 'backup', title: "ğŸ’¾ æ•°æ®é˜²ä¸¢", text: "é‡è¦ï¼è¿™æ˜¯å•æœºç½‘é¡µç‰ˆã€‚\næ¸…ç¼“å­˜æˆ–æ¢æ‰‹æœºå‰ï¼ŒåŠ¡å¿…ç‚¹ã€ä¸‹è½½å¤‡ä»½ã€‘ï¼", target: 'target-backup' },
        { id: 'nav', title: "ğŸ§­ éšæ—¶åˆ‡æ¢", text: "åº•éƒ¨å¯¼èˆªæ éšæ—¶åˆ‡æ¢é¡µé¢ã€‚\næ”¯æŒå·¦å³æ»‘åŠ¨åˆ‡æ¢é¡µé¢å“¦ï¼ğŸš€", target: 'target-nav' }
    ];

    function checkGuide() { if (!localStorage.getItem('hasSeenGuide')) setTimeout(startGuide, 500); }
    function forceGuide() { localStorage.removeItem('hasSeenGuide'); location.reload(); }
    function startGuide() { document.getElementById('spotlight-overlay').style.display = 'block'; guideStep = 0; renderGuideStep(guideStep); }
    function endGuide() { document.getElementById('spotlight-overlay').style.display = 'none'; document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight')); localStorage.setItem('hasSeenGuide', 'true'); switchView('home'); }
    function showBigSuccess() { const o = document.getElementById('success-overlay'); o.style.display = 'flex'; playSound('pop'); setTimeout(() => { o.style.display = 'none'; }, 3000); }
    function nextGuide() { guideStep++; if (guideStep >= guideData.length) { endGuide(); showBigSuccess(); } else { renderGuideStep(guideStep); } }

    function renderGuideStep(index) {
        const step = guideData[index];
        const spotBox = document.getElementById('spotlight-box');
        const tooltip = document.getElementById('guide-tooltip');
        document.getElementById('guide-title').innerText = step.title;
        document.getElementById('guide-text').innerText = step.text;
        if (step.id === 'chart') switchView('charts');
        if (step.id === 'backup') switchView('settings');
        document.querySelectorAll('.guide-highlight').forEach(el => el.classList.remove('guide-highlight'));
        setTimeout(() => {
            tooltip.classList.remove('top-mode', 'bottom-mode', 'center-mode');
            if (step.target) {
                const targetEl = document.getElementById(step.target);
                if(targetEl) {
                    targetEl.classList.add('guide-highlight');
                    const rect = targetEl.getBoundingClientRect();
                    spotBox.style.width = rect.width + 'px';
                    spotBox.style.height = rect.height + 'px';
                    spotBox.style.top = rect.top + 'px';
                    spotBox.style.left = rect.left + 'px';
                    spotBox.style.borderRadius = getComputedStyle(targetEl).borderRadius;
                    spotBox.style.opacity = 1;
                    const screenH = window.innerHeight;
                    if ((rect.top + rect.height / 2) < screenH * 0.55) tooltip.classList.add('bottom-mode');
                    else tooltip.classList.add('top-mode');
                    tooltip.classList.add('show');
                }
            } else {
                spotBox.style.opacity = 0; spotBox.style.top = '-1000px'; 
                tooltip.classList.add('center-mode'); tooltip.classList.add('show');
            }
        }, 150);
    }

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
        if (type === 'coin') { osc.type = 'sine'; osc.frequency.setValueAtTime(1200, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5); osc.start(now); osc.stop(now + 0.5); } 
        else if (type === 'swoosh') { osc.type = 'triangle'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); } 
        else if (type === 'pop') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(600, now + 0.1); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15); osc.start(now); osc.stop(now + 0.15); }
    }

    function playAnim(type) {
        const layer = document.getElementById('anim-layer');
        layer.style.display = 'block'; layer.innerHTML = '';
        if (type === 'guide_success') { playSound('coin'); document.getElementById('success-overlay').style.display = 'flex'; setTimeout(() => { document.getElementById('success-overlay').style.display = 'none'; layer.style.display = 'none'; }, 3000); return; }
        if(['income', 'savings_in', 'debt_in'].includes(type)) {
            playSound('coin'); let emoji = 'ğŸ˜º', text = 'æ”¶å…¥åˆ°è´¦!';
            if(type === 'savings_in') { emoji = 'ğŸ·'; text = 'å­˜é’±æˆåŠŸ!'; } if(type === 'debt_in') { emoji = 'ğŸ’'; text = 'æ”¶å›æ¬ æ¬¾!'; }
            layer.innerHTML = `<div class="pop-anim">${emoji}<span class="pop-text">${text}</span></div>`;
            setTimeout(() => { layer.style.display = 'none'; }, 2000);
        } else if(['expense', 'savings_out', 'debt_out'].includes(type)) {
            playSound('swoosh'); let emoji = 'ğŸ­', tag = 'ğŸ’°';
            if(type === 'savings_out') { emoji = 'ğŸ’¸'; tag = ''; } if(type === 'debt_out') { emoji = 'ğŸ¤'; tag = 'ğŸ“¤'; }
            layer.innerHTML = `<div class="run-anim"><div class="bounce-body"><span>${emoji}</span>${tag ? `<span class="money-tag">${tag}</span>` : ''}</div></div>`;
            setTimeout(() => { layer.style.display = 'none'; }, 2500);
        }
    }

    let toastTimer;
    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show');
        clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
    }

    function setBudget() {
        const val = prompt("è¯·è¾“å…¥æœ¬æœˆé¢„ç®—é‡‘é¢ï¼š", currentBudget);
        if(val !== null) { playSound('pop'); currentBudget = parseFloat(val) || 0; localStorage.setItem('monthlyBudget', currentBudget); updateHomeStats(); }
    }

    function updateCategoryOptions() {
        const type = document.getElementById('type').value;
        const select = document.getElementById('category'); select.innerHTML = '';
        (categoryData[type] || []).forEach(c => {
            const opt = document.createElement('option'); opt.value = c.name; opt.innerHTML = `${c.icon} ${c.name}`; select.appendChild(opt);
        });
        const btn = document.getElementById('btn-submit');
        if(type==='expense') { btn.style.background = 'var(--danger)'; btn.innerText = 'ğŸ’¸ ç¡®è®¤æ”¯å‡º'; }
        else if(type==='income') { btn.style.background = 'var(--success)'; btn.innerText = 'ğŸ’° ç¡®è®¤æ”¶å…¥'; }
        else { btn.style.background = 'var(--primary)'; btn.innerText = 'âœ¨ æäº¤è®°å½•'; }
    }

    // ä¿®å¤ï¼šå¯¼å…¥é€»è¾‘ä¼˜åŒ–ï¼Œé¿å…å‡æŠ¥é”™
    window.importData = function(input) {
        const file = input.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                // 1. å…ˆå°è¯•è§£æ
                const data = JSON.parse(e.target.result);
                // 2. æ ¡éªŒæ•°æ®æ ¼å¼
                if (!Array.isArray(data)) throw new Error("Format Error");
                // 3. å­˜å…¥
                transactions = data;
                localStorage.setItem('transactions', JSON.stringify(transactions));
                // 4. åˆ·æ–°ç•Œé¢
                updateHomeStats();
                if(currentViewIndex === 1) renderChartsPage();
                showToast("âœ… æ•°æ®å·²æ¢å¤");
            } catch(err) {
                console.error(err);
                showToast("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯");
            }
        };
        r.readAsText(file);
        input.value = '';
    }

    document.getElementById('transaction-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const amtInput = document.getElementById('amount');
        if (!amtInput.value || parseFloat(amtInput.value) === 0) { showToast("âš ï¸ é‡‘é¢ä¸èƒ½ä¸º 0"); return; }
        const typeSelect = document.getElementById('type');
        const catSelect = document.getElementById('category');
        const userNote = document.getElementById('text').value.trim();
        const t = {
            id: Date.now(), date: document.getElementById('date').value,
            amount: parseFloat(amtInput.value),
            type: typeSelect.value, category: catSelect.value, icon: 'ğŸ“', text: userNote
        };
        transactions.push(t); localStorage.setItem('transactions', JSON.stringify(transactions));
        playAnim(t.type); amtInput.value = ''; document.getElementById('text').value = '';
        document.activeElement.blur(); updateHomeStats();
        if(document.getElementById('spotlight-overlay').style.display !== 'none' && guideStep === 2) setTimeout(() => nextGuide(), 1000);
    });

    function getEmptyHTML(text, icon='ğŸ“') { return `<div class="list-empty-state"><span class="empty-icon">${icon}</span><div class="empty-text">${text}</div></div>`; }
    function getListItemHTML(t) {
        let colorClass = '#333'; let sign = '';
        if(t.type === 'income') { colorClass = 'var(--success)'; sign='+'; }
        else if(t.type === 'expense') { colorClass = 'var(--danger)'; sign='-'; }
        else if(t.type.startsWith('debt')) { colorClass = 'var(--warning)'; }
        const displayTitle = t.text || t.category;
        return `<li class="trans-item"><div class="t-left"><div class="t-icon">ğŸ“</div><div class="t-info"><h4>${displayTitle}</h4><span>${t.date} Â· ${t.category}</span></div></div><div class="t-left"><span class="t-amount" style="color:${colorClass}">${sign}Â¥${t.amount.toFixed(2)}</span><button class="del-btn" onclick="delItem(${t.id})">Ã—</button></div></li>`;
    }

    function updateHomeStats() {
        transactions.sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
        let income=0, expense=0, savings=0, debt=0;
        const now = new Date(); const curM = now.getMonth(); const curY = now.getFullYear();
        transactions.forEach(t => {
            const d = new Date(t.date);
            const isCurMonth = d.getMonth() === curM && d.getFullYear() === curY;
            if(t.type === 'income' && isCurMonth) income += t.amount;
            if(t.type === 'expense' && isCurMonth) expense += t.amount;
            if(t.type === 'savings_in') savings += t.amount;
            if(t.type === 'savings_out') savings -= t.amount;
            if(t.type === 'debt_out') debt += t.amount;
            if(t.type === 'debt_in') debt -= t.amount;
        });
        document.getElementById('month-income').innerText = `Â¥${income.toFixed(2)}`;
        document.getElementById('month-expense').innerText = `Â¥${expense.toFixed(2)}`;
        document.getElementById('total-savings').innerText = `Â¥${savings.toFixed(2)}`;
        document.getElementById('total-debt').innerText = `Â¥${debt.toFixed(2)}`;
        document.getElementById('budget-display').innerText = `Â¥${currentBudget.toFixed(2)}`;
        const pct = currentBudget > 0 ? (expense / currentBudget) * 100 : 0;
        document.getElementById('budget-fill').style.width = Math.min(pct, 100) + '%';
        document.getElementById('budget-fill').style.background = pct > 100 ? 'var(--danger)' : 'var(--success)';
        document.getElementById('budget-text').innerText = `å·²ç”¨ ${pct.toFixed(0)}%`;
        document.getElementById('budget-remaining').innerText = `Â¥${(currentBudget - expense).toFixed(2)}`;
        const recentList = document.getElementById('recent-list');
        if (transactions.length === 0) recentList.innerHTML = getEmptyHTML("æš‚æ— è®°å½•ï¼Œå¿«å»è®°ä¸€ç¬”~");
        else recentList.innerHTML = transactions.slice(0, 5).map(getListItemHTML).join('');
    }

    window.delItem = function(id) {
        if(confirm("åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ")) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateHomeStats(); renderChartsPage();
        }
    }

    function getFilteredData() {
        const s = document.getElementById('start-date').value;
        const e = document.getElementById('end-date').value;
        if(!s || !e) return transactions;
        const start = new Date(s); const end = new Date(e);
        return transactions.filter(t => { const d = new Date(t.date); return d >= start && d <= end; });
    }

    function renderChartsPage() {
        const data = getFilteredData();
        const listEl = document.getElementById('full-list');
        if (!data || data.length === 0) { listEl.innerHTML = getEmptyHTML("æ‰¾ä¸åˆ°ç›¸å…³è®°å½•", "ğŸ”"); } 
        else { listEl.innerHTML = data.map(getListItemHTML).join(''); }
        updateAllCharts();
    }

    function renderFullList() { renderChartsPage(); }

    let myCharts = {};
    function switchChart(type) {
        currentTab = type;
        document.querySelectorAll('.chart-pill').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.chart-view').forEach(el => { el.style.visibility='hidden'; el.style.zIndex=0; el.classList.remove('active'); });
        const target = document.getElementById(`chart-view-${type}`);
        target.style.visibility='visible'; target.style.zIndex=1; target.classList.add('active');
        updateEmptyStateVisibility();
    }

    function updateEmptyStateVisibility() {
        const emptyState = document.getElementById('chart-empty-state');
        const canvases = document.querySelectorAll('canvas');
        if (chartDataStatus[currentTab] === false) {
            emptyState.style.display = 'flex'; 
            canvases.forEach(c => c.style.visibility = 'hidden'); 
        } else {
            emptyState.style.display = 'none'; 
            canvases.forEach(c => c.style.visibility = 'visible'); 
        }
    }

    function updateAllCharts() {
        const data = getFilteredData();
        chartDataStatus = { expense: false, income: false, savings: false, debt: false };
        renderChart('expense', 'expense', data); 
        renderChart('income', 'income', data);
        renderChart('savings', 'savings_in', data); 
        renderChart('debt', 'debt_out', data);
        updateEmptyStateVisibility();
    }

    function renderChart(canvasId, typeKey, sourceData) {
        const ctx = document.getElementById(canvasId + 'Chart').getContext('2d');
        const dataMap = {};
        const filteredData = sourceData.filter(t => t.type === typeKey);
        
        if (filteredData.length > 0) {
            chartDataStatus[typeKey === 'savings_in' ? 'savings' : (typeKey === 'debt_out' ? 'debt' : typeKey)] = true;
        }

        filteredData.forEach(t => { dataMap[t.category] = (dataMap[t.category] || 0) + t.amount; });
        
        if(myCharts[canvasId]) myCharts[canvasId].destroy();
        
        const labels = Object.keys(dataMap);
        const values = Object.values(dataMap);
        const isBar = currentChartType === 'bar';
        
        myCharts[canvasId] = new Chart(ctx, {
            type: currentChartType,
            data: {
                labels: labels,
                datasets: [{ 
                    data: values, 
                    backgroundColor: ['#4e54c8','#ff7675','#00b894','#fdcb6e','#af52de','#5ac8fa'], 
                    borderWidth: 0,
                    borderRadius: isBar ? 4 : 0 
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: !isBar, position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.raw;
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = total === 0 ? 0 : Math.round((value / total) * 100);
                                return label + ': ' + value.toFixed(2) + ' (' + percentage + '%)';
                            }
                        }
                    }
                },
                scales: isBar ? { y: { beginAtZero: true } } : { x: { display: false }, y: { display: false } }
            }
        });
    }

    function renderManageList() {
        const type = document.getElementById('manage-type-select').value;
        const ul = document.getElementById('manage-list');
        ul.innerHTML = (categoryData[type]||[]).map((c, i) => `
            <li class="cat-item">
                <span class="cat-name-span">${c.icon} ${c.name}</span>
                <div class="cat-actions">
                    <button class="cat-btn btn-edit" onclick="editCat('${type}', ${i})">ç¼–è¾‘</button>
                    <button class="cat-btn btn-del" onclick="delCat('${type}', ${i})">åˆ é™¤</button>
                </div>
            </li>
        `).join('');
    }
    
    window.editCat = function(type, idx) {
        const oldCat = categoryData[type][idx];
        const newName = prompt("è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:", oldCat.name);
        if (newName) {
            const newIcon = prompt("è¯·è¾“å…¥æ–°çš„å›¾æ ‡ Emoji:", oldCat.icon);
            categoryData[type][idx] = { name: newName, icon: newIcon || oldCat.icon };
            localStorage.setItem('categoryData', JSON.stringify(categoryData));
            renderManageList(); updateCategoryOptions(); showToast("âœ… ä¿®æ”¹æˆåŠŸ");
        }
    }

    window.delCat = function(type, idx) {
        if(confirm("åˆ é™¤æ­¤åˆ†ç±»ï¼Ÿ")) {
            categoryData[type].splice(idx, 1); localStorage.setItem('categoryData', JSON.stringify(categoryData));
            renderManageList(); updateCategoryOptions();
        }
    }
    window.addNewCategory = function() {
        const type = document.getElementById('manage-type-select').value;
        const name = document.getElementById('new-cat-name').value;
        const icon = document.getElementById('new-cat-icon').value || 'ğŸ·ï¸';
        if(name) {
            playSound('pop');
            categoryData[type].push({name, icon}); localStorage.setItem('categoryData', JSON.stringify(categoryData));
            renderManageList(); updateCategoryOptions(); document.getElementById('new-cat-name').value = ''; showToast("âœ… åˆ†ç±»å·²æ·»åŠ ");
        }
    }

    window.exportToExcel = function() {
        playSound('swoosh');
        if(transactions.length===0) return showToast("æ— æ•°æ®");
        const typeMap = { 'expense': 'æ”¯å‡º', 'income': 'æ”¶å…¥', 'savings_in': 'å­˜å…¥å‚¨è“„', 'savings_out': 'å–å‡ºå‚¨è“„', 'debt_out': 'å€Ÿå‡ºå€ºæƒ', 'debt_in': 'æ”¶å›å€ºæƒ' };
        let str = "\uFEFFæ—¥æœŸ,ç±»å‹,åˆ†ç±»,å¤‡æ³¨,é‡‘é¢\n";
        transactions.forEach(t=> {
            let typeStr = typeMap[t.type] || t.type;
            let noteStr = t.text ? t.text.replace(/,/g, "ï¼Œ") : ""; 
            str+=`${t.date},${typeStr},${t.category},${noteStr},${t.amount}\n`;
        });
        const link = document.createElement('a'); 
        const blob = new Blob([str], { type: 'text/csv;charset=utf-8;' });
        link.href = URL.createObjectURL(blob);
        link.download = `è´¢åŠ¡è´¦å•_${new Date().toLocaleDateString()}.csv`; link.click();
    }

    window.exportData = function() {
        playSound('swoosh'); const str = JSON.stringify(transactions);
        const link = document.createElement('a'); link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(str); link.download = 'backup.json'; link.click();
    }

    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth() + 1).padStart(2, '0');
    const d = String(today.getDate()).padStart(2, '0');
    document.getElementById('date').value = `${y}-${m}-${d}`;
    document.getElementById('end-date').value = `${y}-${m}-${d}`;
    document.getElementById('start-date').value = `${y}-${m}-01`;

    updateCategoryOptions(); updateHomeStats(); checkGuide();
</script>

</body>
</html>
